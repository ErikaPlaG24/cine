<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cine Premium - Iniciar Sesi√≥n</title>
    <link rel="stylesheet" href="estilos.css">
</head>
<body> 
    <div id="login">
        <form id="loginForm" class="login-form" onsubmit="iniciarSesion(); return false;">
            <h2><span aria-label="claqueta" title="Cine">üé¨</span> Cine Premium - Iniciar Sesi√≥n</h2>
            <div class="form-group">
                <label for="usuario">Usuario</label>
                <input type="text" id="usuario" placeholder="Usuario" required>
            </div>
            <div class="form-group">
                <label for="contrasena">Contrase√±a</label>
                <input type="password" id="contrasena" placeholder="Contrase√±a" required>
            </div>
            <button type="submit" class="btn-login"><span aria-label="ticket" title="Entrar">üéüÔ∏è</span> Entrar</button>
            
            </div>
        </form>
    </div>

    <script src="config.js"></script>
    <script src="api.js"></script>
    
    <script>
        let nombreUsuario = "";
        let currentUser = null;

        async function iniciarSesion() {
            const user = document.getElementById("usuario").value;
            const pass = document.getElementById("contrasena").value;
            
            console.log('Iniciando sesi√≥n con:', user, pass);
            
            // Validaci√≥n b√°sica
            if (!user || user.trim() === '') {
                alert('Por favor ingrese un usuario');
                return;
            }
            
            if (!pass || pass.trim() === '') {
                alert('Por favor ingrese una contrase√±a');
                return;
            }

            const loginButton = document.querySelector('.btn-login');
            
            try {
                // Mostrar estado de carga
                loginButton.textContent = 'üîÑ Cargando...';
                loginButton.disabled = true;

                console.log('Llamando a AuthAPI.login...');
                const response = await AuthAPI.login(user, pass);
                console.log('Respuesta del login:', response);
                
                if (response && response.access_token) {
                    // Guardar datos del usuario en localStorage
                    localStorage.setItem('cinemaUser', JSON.stringify({
                        username: user,
                        token: response.access_token,
                        user: response.user || { username: user }
                    }));
                    
                    // Mostrar mensaje de √©xito y redireccionar autom√°ticamente
                    console.log('‚úÖ Login exitoso, redirigiendo...');
                    loginButton.textContent = '‚úÖ ¬°√âxito! Redirigiendo...';
                    
                    // Redireccionar inmediatamente a la p√°gina de reservas
                    setTimeout(() => {
                        window.location.href = 'reservas.html';
                    }, 500);
                } else {
                    throw new Error('Respuesta inv√°lida del servidor');
                }
            } catch (error) {
                console.error('Error completo:', error);
                alert("Error al iniciar sesi√≥n: " + error.message);
            } finally {
                // Restaurar bot√≥n
                loginButton.textContent = 'üéüÔ∏è Entrar';
                loginButton.disabled = false;
            }
        }

        // Verificar si ya est√° autenticado
        window.addEventListener('DOMContentLoaded', function() {
            if (isAuthenticated()) {
                window.location.href = 'reservas.html';
            }
        });

        async function testServerConnection() {
            try {
                console.log('Probando conexi√≥n al servidor...');
                const response = await fetch('http://localhost:8000/');
                const data = await response.json();
                console.log('Respuesta del servidor:', data);
                alert('‚úÖ Servidor conectado: ' + data.message);
            } catch (error) {
                console.error('Error de conexi√≥n:', error);
                alert('‚ùå Error de conexi√≥n: ' + error.message);
            }
        }
    </script>
</body>
</html>
