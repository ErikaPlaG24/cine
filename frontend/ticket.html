<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cine Premium - Tu Boleto</title>
    <link rel="stylesheet" href="estilos.css">
</head>
<body> 
    <!-- La navegaci√≥n se inserta autom√°ticamente aqu√≠ -->

    <div class="container" style="max-width: 800px; margin: 0 auto; padding: 0 20px;">
        <div id="ticket" style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 2px dashed #667eea;">
            <h2 style="text-align: center; color: #667eea; margin-bottom: 30px;">
                <span aria-label="ticket" title="Boleto">üé´</span> Tu Boleto de Cine
            </h2>
            
            <div id="ticketContent" style="background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 25px;">
                <p id="detallesBoleto" style="font-size: 16px; line-height: 1.6; margin-bottom: 20px;"></p>
                <p id="totalPago" style="font-size: 20px; font-weight: bold; color: #28a745; text-align: center; background: white; padding: 15px; border-radius: 8px; margin: 0;"></p>
            </div>
            
            <!-- Botones de acci√≥n -->
            <div style="text-align: center; margin-top: 25px;">
    
                <button onclick="descargarPDF()" style="background: #E53E3E; color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 16px; cursor: pointer; margin-right: 15px; transition: background 0.3s;" onmouseover="this.style.background='#C53030'" onmouseout="this.style.background='#E53E3E'">
                    üìÑ Descargar PDF
                </button>
                <button onclick="nuevaCompra()" style="background: #2196F3; color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 16px; cursor: pointer; transition: background 0.3s;" onmouseover="this.style.background='#1976D2'" onmouseout="this.style.background='#2196F3'">
                    üîô Nueva Compra
                </button>
            </div>
            
            <!-- Informaci√≥n adicional -->
            <div style="margin-top: 30px; padding: 20px; background: #e8f4fd; border-radius: 8px; text-align: center;">
                <p style="margin: 0; color: #333; font-size: 14px;">
                    <strong>¬°Gracias por elegir Cine Premium!</strong><br>
                    Conserve este boleto para ingresar a la sala.<br>
                    Llegue 15 minutos antes de la funci√≥n.
                </p>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="api.js"></script>
    <script src="script-ticket.js"></script>
    
    <!-- Librer√≠as para PDF con m√∫ltiples CDNs de respaldo -->
    <script>
        // Funci√≥n para cargar scripts con fallback
        function loadScriptWithFallback(urls, callback, errorCallback) {
            let currentIndex = 0;
            
            function tryLoad() {
                if (currentIndex >= urls.length) {
                    if (errorCallback) errorCallback();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = urls[currentIndex];
                script.onload = callback;
                script.onerror = () => {
                    console.log(`Failed to load ${urls[currentIndex]}, trying next...`);
                    currentIndex++;
                    tryLoad();
                };
                document.head.appendChild(script);
            }
            
            tryLoad();
        }
        
        // Cargar html2canvas
        console.log('Cargando html2canvas...');
        loadScriptWithFallback([
            'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js',
            'https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js',
            'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js'
        ], function() {
            console.log('html2canvas cargado exitosamente');
            window.html2canvasLoaded = true;
            
            // Verificar que html2canvas est√° disponible globalmente
            if (typeof window.html2canvas === 'undefined' && typeof html2canvas !== 'undefined') {
                window.html2canvas = html2canvas;
            }
            
            // Ahora cargar jsPDF
            console.log('Cargando jsPDF...');
            loadScriptWithFallback([
                'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
                'https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js',
                'https://cdn.jsdelivr.net/npm/jspdf@latest/dist/jspdf.umd.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js'
            ], function() {
                console.log('jsPDF cargado exitosamente');
                window.jsPDFLoaded = true;
                
                // Verificar que jsPDF est√° disponible globalmente y exponerlo correctamente
                if (typeof window.jsPDF === 'undefined') {
                    // Intentar diferentes formas de acceso
                    if (typeof jsPDF !== 'undefined') {
                        window.jsPDF = jsPDF;
                    } else if (typeof window.jspdf !== 'undefined') {
                        window.jsPDF = window.jspdf.jsPDF || window.jspdf;
                    } else if (typeof jspdf !== 'undefined') {
                        window.jsPDF = jspdf.jsPDF || jspdf;
                    }
                }
                
                console.log('jsPDF disponible como:', typeof window.jsPDF);
                console.log('jspdf disponible como:', typeof window.jspdf);
            }, function() {
                console.error('No se pudo cargar jsPDF desde ning√∫n CDN');
            });
            
        }, function() {
            console.error('No se pudo cargar html2canvas desde ning√∫n CDN');
        });
    </script>
    
    <script>
        // Verificar autenticaci√≥n al cargar la p√°gina
        window.addEventListener('DOMContentLoaded', function() {
            console.log('üé´ Cargando p√°gina de ticket...');
            console.log('üîê Verificando autenticaci√≥n...');
            
            if (!isAuthenticated()) {
                console.log('‚ùå No autenticado, redirigiendo a login...');
                alert('Sesi√≥n expirada. Ser√°s redirigido al login.');
                window.location.href = 'login.html';
                return;
            } else {
                console.log('‚úÖ Usuario autenticado correctamente');
            }
            
            // Mostrar nombre del usuario
            const userData = getUserData();
            if (userData) {
                document.getElementById('welcomeMessage').textContent = `Bienvenido, ${userData.username}`;
                console.log('üë§ Usuario:', userData.username);
            }
            
            // Cargar datos del ticket desde localStorage
            console.log('üé´ Cargando datos del ticket...');
            cargarTicket();
        });

        // La funci√≥n cerrarSesion est√° ahora en navigation.js
        
        function nuevaCompra() {
            window.location.href = 'reservas.html';
        }
    </script>
    <script src="config.js"></script>
    <script src="api.js"></script>
    <!-- Navegaci√≥n unificada (despu√©s de api.js) -->
    <script src="navigation.js"></script>
    <script src="script-ticket.js"></script>
</body>
</html>
